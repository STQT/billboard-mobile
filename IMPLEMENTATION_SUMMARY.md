# Резюме реализации планирования плейлистов

## Что было сделано

Изменена логика генерации плейлистов для учета временных слотов контрактных видео и заполнения свободного времени филлерами.

## Изменения в Backend

### 1. `/backend/app/services/playlist_service.py`

**Изменено:**
- Метод `generate_hourly_playlist()` - теперь использует новую логику планирования
- **Добавлен** метод `_generate_scheduled_playlist()` - создает плейлист с учетом временных слотов
  - Размещает контрактные видео равномерно согласно `plays_per_hour`
  - Избегает наложения контрактных видео друг на друга
  - Заполняет свободные промежутки филлерами
- **Удален** метод `_distribute_evenly()` - заменен новой логикой

**Логика работы:**
```python
1. Для каждого контрактного видео:
   - Вычисляется интервал = 3600 / plays_per_hour
   - Видео размещается в определенных временных слотах
   - Добавляется смещение для разных видео, чтобы избежать наложения

2. Находятся свободные промежутки между контрактными видео

3. Свободные промежутки заполняются филлерами
```

### 2. `/backend/app/schemas/schemas.py`

**Изменено:**
- Класс `PlaylistResponse` - добавлено поле `video_sequence: List[int]`
  - Упорядоченная последовательность ID видео для воспроизведения

### 3. `/backend/app/api/routes.py`

**Изменено:**
- **Добавлена** функция `_build_playlist_response()` - вспомогательная функция для построения PlaylistResponse
- Обновлены все эндпоинты плейлистов для использования новой функции:
  - `GET /playlists/current`
  - `POST /playlists/regenerate`
  - `GET /playlists/vehicle/{vehicle_id}`
  - `POST /playlists/vehicle/{vehicle_id}/regenerate`
  - `GET /playlists/tariff/{tariff}`
  - `POST /playlists/tariff/{tariff}/regenerate`

## Изменения в Mobile App

### 1. `/mobile/lib/models/playlist.dart`

**Изменено:**
- Класс `Playlist` - добавлено поле `videoSequence: List<int>`
- Метод `allVideoIds` - теперь возвращает уникальные ID из `videoSequence`

### 2. `/mobile/lib/services/video_service.dart`

**Изменено:**
- Метод `_loadVideos()` - теперь использует `videoSequence` для построения правильного порядка воспроизведения
- Видео воспроизводятся в порядке, возвращенном сервером (контрактные в своих слотах, филлеры в промежутках)

## Примеры работы

### Пример 1: Два контрактных видео с одинаковой частотой
```
Контрактное видео #1: 30 секунд, 4 раза в час
Контрактное видео #2: 30 секунд, 4 раза в час
Филлер: 60 секунд

Результат:
00:00 - Контрактное #1 (30с)
00:30 - Контрактное #2 (30с)  ← Смещено, чтобы не накладываться
01:00 - Филлер (60с)
02:00 - Филлер (60с)
...
15:00 - Контрактное #1 (30с)
15:30 - Контрактное #2 (30с)
...
```

### Пример 2: Одно контрактное видео
```
Контрактное видео: 60 секунд, 6 раз в час
Филлер: 30 секунд

Результат:
00:00 - Контрактное (60с)
01:00 - Филлер (30с)
01:30 - Филлер (30с)
...
10:00 - Контрактное (60с)
11:00 - Филлер (30с)
...
```

## Преимущества новой реализации

1. ✅ **Точный контроль показов** - контрактные видео показываются строго определенное количество раз в час
2. ✅ **Равномерное распределение** - контрактные видео распределяются равномерно по всему часу
3. ✅ **Отсутствие наложений** - контрактные видео не накладываются друг на друга
4. ✅ **Оптимальное использование времени** - филлеры заполняют все свободное время
5. ✅ **Обратная совместимость** - API остается прежним, добавлено только новое поле

## Тестирование

Рекомендуется протестировать:

1. ✅ Плейлист с несколькими контрактными видео с одинаковой частотой
2. ✅ Плейлист с контрактными видео с разной частотой
3. ✅ Плейлист только с филлерами (должен работать как раньше)
4. ✅ Проверка общей длительности плейлиста (~1 час)
5. ✅ Проверка правильности воспроизведения на мобильном устройстве

## Файлы с изменениями

### Backend:
- `backend/app/services/playlist_service.py` (изменен)
- `backend/app/schemas/schemas.py` (изменен)
- `backend/app/api/routes.py` (изменен)

### Mobile:
- `mobile/lib/models/playlist.dart` (изменен)
- `mobile/lib/services/video_service.dart` (изменен)

### Документация:
- `PLAYLIST_SCHEDULING_CHANGES.md` (создан)
- `IMPLEMENTATION_SUMMARY.md` (создан)

## Запуск

Изменения совместимы с текущей версией. Не требуется миграция БД.

1. Перезапустить backend сервер
2. Пересобрать и запустить мобильное приложение
3. Протестировать генерацию нового плейлиста

```bash
# Backend (если используется Docker)
docker-compose restart backend

# Mobile
flutter clean
flutter pub get
flutter run
```
