#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

set -e

echo "=========================================="
echo "  –°–±—Ä–æ—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö Billboard Mobile"
echo "=========================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–µ—Ä–µ–Ω
read -p "‚ö†Ô∏è  –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã! –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/N): " confirm
if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    echo "–û—Ç–º–µ–Ω–µ–Ω–æ."
    exit 0
fi

echo ""
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker compose down

echo ""
echo "üóëÔ∏è  –£–¥–∞–ª—è–µ–º volume —Å –¥–∞–Ω–Ω—ã–º–∏ PostgreSQL..."
docker volume rm billboard-mobile_postgres_data 2>/dev/null || echo "Volume —É–∂–µ —É–¥–∞–ª–µ–Ω –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"

echo ""
echo "üóëÔ∏è  –£–¥–∞–ª—è–µ–º volume —Å –¥–∞–Ω–Ω—ã–º–∏ Redis..."
docker volume rm billboard-mobile_redis_data 2>/dev/null || echo "Volume —É–∂–µ —É–¥–∞–ª–µ–Ω –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"

echo ""
echo "üßπ –û—á–∏—â–∞–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –≤–∏–¥–µ–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)..."
read -p "–£–¥–∞–ª–∏—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –≤–∏–¥–µ–æ –∏–∑ ./uploads/videos/? (y/N): " del_videos
if [[ "$del_videos" =~ ^[Yy]$ ]]; then
    rm -rf ./uploads/videos/*
    echo "‚úÖ –í–∏–¥–µ–æ —É–¥–∞–ª–µ–Ω—ã"
else
    echo "‚è≠Ô∏è  –í–∏–¥–µ–æ –æ—Å—Ç–∞–≤–ª–µ–Ω—ã"
fi

echo ""
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–Ω–æ–≤–æ..."
docker compose up -d

echo ""
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ PostgreSQL..."
sleep 5

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –±–∞–∑–∞ —Å–æ–∑–¥–∞–Ω–∞
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ..."
docker compose exec -T postgres psql -U billboard_user -d billboard_db -c "SELECT 'Database is ready!' AS status;" 2>/dev/null && echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞" || echo "‚ö†Ô∏è  –ë–∞–∑–∞ –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ"

echo ""
echo "=========================================="
echo "‚úÖ –°–±—Ä–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "=========================================="
echo ""
echo "üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞—è - —Ç–∞–±–ª–∏—Ü—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ backend"
echo "2. –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—É—Å—Ç–∏—Ç–µ:"
echo "   docker compose exec backend python seed_test_data.py"
echo "3. –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –≤–∏–¥–µ–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:"
echo "   ./create_test_videos.sh"
echo ""
