# Архитектура системы Billboard Mobile

## Общая архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                     Flutter Mobile App                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Video Player │  │ Auth Service │  │  Analytics   │      │
│  │   Screen     │  │              │  │   Service    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│         │                 │                   │              │
│         └─────────────────┴───────────────────┘              │
│                           │                                  │
│                    ┌──────────────┐                          │
│                    │ API Service  │                          │
│                    │   (Dio)      │                          │
│                    └──────────────┘                          │
│                           │                                  │
└───────────────────────────┼──────────────────────────────────┘
                            │ HTTP/REST
                            │
┌───────────────────────────┼──────────────────────────────────┐
│                           ▼                                  │
│                   FastAPI Backend                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Auth API    │  │  Video API   │  │ Analytics    │      │
│  │              │  │              │  │     API      │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│         │                 │                   │              │
│         └─────────────────┴───────────────────┘              │
│                           │                                  │
│         ┌─────────────────┴─────────────────┐                │
│         │                                   │                │
│  ┌──────▼──────┐                    ┌──────▼──────┐         │
│  │  Playlist   │                    │  Analytics  │         │
│  │   Service   │                    │   Service   │         │
│  └──────┬──────┘                    └──────┬──────┘         │
│         │                                   │                │
└─────────┼───────────────────────────────────┼────────────────┘
          │                                   │
          └───────────┬───────────────────────┘
                      │
          ┌───────────▼───────────┐
          │    SQLAlchemy ORM     │
          └───────────┬───────────┘
                      │
          ┌───────────▼───────────┐       ┌──────────────┐
          │    PostgreSQL DB      │       │    Redis     │
          │                       │       │   (Cache)    │
          │  ┌─────────────────┐  │       └──────────────┘
          │  │ vehicles        │  │
          │  │ videos          │  │
          │  │ playlists       │  │
          │  │ playback_logs   │  │
          │  │ vehicle_sessions│  │
          │  └─────────────────┘  │
          └───────────────────────┘
```

## Компоненты системы

### 1. Flutter Mobile App

#### Структура
```
lib/
├── main.dart                  # Точка входа
├── models/                    # Data модели
│   ├── vehicle.dart
│   ├── video.dart
│   └── playlist.dart
├── services/                  # Бизнес-логика и API
│   ├── api_service.dart       # HTTP клиент
│   ├── auth_service.dart      # Аутентификация
│   ├── video_service.dart     # Управление видео
│   └── analytics_service.dart # Аналитика
├── screens/                   # UI экраны
│   ├── login_screen.dart
│   └── video_player_screen.dart
└── widgets/                   # Переиспользуемые виджеты
```

#### Основные функции

**AuthService:**
- Авторизация автомобиля (login/password)
- Хранение JWT токена
- Проверка аутентификации

**VideoService:**
- Загрузка плейлиста с сервера
- Кеширование видео локально
- Управление текущим видео
- Переключение между видео

**AnalyticsService:**
- Управление сессиями работы
- Логирование воспроизведения видео
- Отправка аналитики на сервер
- Подсчет времени работы

**VideoPlayerScreen:**
- Полноэкранное воспроизведение
- Автоматическое переключение видео
- Отображение информации (номер авто, тариф)
- Overlay с кнопками управления

### 2. Backend API (FastAPI)

#### Структура
```
app/
├── main.py                    # Главный файл приложения
├── api/
│   └── routes.py              # API endpoints
├── core/
│   ├── config.py              # Конфигурация
│   └── security.py            # JWT, хеширование паролей
├── db/
│   └── database.py            # Подключение к БД
├── models/
│   └── models.py              # SQLAlchemy модели
├── schemas/
│   └── schemas.py             # Pydantic схемы
└── services/
    ├── playlist_service.py    # Генерация плейлистов
    └── analytics_service.py   # Аналитика
```

#### API Endpoints

**Auth:**
- `POST /api/v1/auth/register` - Регистрация автомобиля
- `POST /api/v1/auth/login` - Получение JWT токена
- `GET /api/v1/auth/me` - Информация о текущем автомобиле

**Videos:**
- `GET /api/v1/videos` - Список видео (с фильтрацией)
- `POST /api/v1/videos` - Загрузка нового видео
- `GET /api/v1/videos/{id}` - Получить конкретное видео
- `PUT /api/v1/videos/{id}` - Обновить видео
- `DELETE /api/v1/videos/{id}` - Удалить видео

**Playlists:**
- `GET /api/v1/playlists/current` - Получить текущий плейлист
- `POST /api/v1/playlists/regenerate` - Сгенерировать новый плейлист

**Sessions:**
- `POST /api/v1/sessions/start` - Начать рабочую сессию
- `POST /api/v1/sessions/end` - Завершить сессию

**Playback:**
- `POST /api/v1/playback` - Записать лог воспроизведения

**Analytics:**
- `GET /api/v1/analytics/me` - Аналитика для текущего автомобиля
- `GET /api/v1/analytics/vehicle/{id}` - Аналитика для конкретного автомобиля

### 3. База данных (PostgreSQL)

#### Схема таблиц

**vehicles** - Автомобили (пользователи)
```sql
id                 INTEGER PRIMARY KEY
login              VARCHAR(100) UNIQUE
hashed_password    VARCHAR(255)
car_number         VARCHAR(20) UNIQUE
tariff             ENUM (standard, comfort, business, premium)
driver_name        VARCHAR(200)
phone              VARCHAR(20)
is_active          BOOLEAN
created_at         TIMESTAMP
updated_at         TIMESTAMP
```

**videos** - Видео контент
```sql
id                 INTEGER PRIMARY KEY
title              VARCHAR(255)
filename           VARCHAR(500)
file_path          VARCHAR(1000)
file_size          INTEGER
duration           FLOAT
video_type         ENUM (filler, contract)
plays_per_hour     INTEGER  -- для контрактных видео
tariffs            VARCHAR(200)  -- "standard,comfort,business"
priority           INTEGER
is_active          BOOLEAN
created_at         TIMESTAMP
updated_at         TIMESTAMP
```

**playlists** - Сгенерированные плейлисты
```sql
id                 INTEGER PRIMARY KEY
vehicle_id         INTEGER FK -> vehicles
tariff             ENUM
video_sequence     TEXT  -- JSON: [1, 5, 3, 2, ...]
valid_from         TIMESTAMP
valid_until        TIMESTAMP
created_at         TIMESTAMP
```

**vehicle_sessions** - Сессии работы автомобилей
```sql
id                       INTEGER PRIMARY KEY
vehicle_id               INTEGER FK -> vehicles
start_time               TIMESTAMP
end_time                 TIMESTAMP
total_duration_seconds   INTEGER
videos_played            INTEGER
```

**playback_logs** - Логи воспроизведения
```sql
id                 INTEGER PRIMARY KEY
vehicle_id         INTEGER FK -> vehicles
video_id           INTEGER FK -> videos
session_id         INTEGER FK -> vehicle_sessions
played_at          TIMESTAMP
duration_seconds   FLOAT
is_prime_time      BOOLEAN
completed          BOOLEAN
created_at         TIMESTAMP
```

## Алгоритмы

### Генерация плейлиста

**Цель:** Создать последовательность видео на N часов с учетом:
- Контрактных видео (определенное количество показов в час)
- Филлеров (заполняют оставшееся время)
- Равномерного распределения контрактных видео

**Алгоритм:**

1. Получить все активные видео для данного тарифа
2. Разделить на контрактные и филлеры
3. Для каждого часа:
   - Добавить контрактные видео с нужной частотой
   - Рассчитать оставшееся время в часе
   - Заполнить филлерами
4. Равномерно распределить контрактные видео по плейлисту
5. Сохранить последовательность в БД

**Пример:**
- Контрактное видео A: 3 показа/час, 20 сек
- Контрактное видео B: 2 показа/час, 30 сек
- Филлер C: 15 сек
- Филлер D: 25 сек

В час:
- A: 3 раза = 60 сек
- B: 2 раза = 60 сек
- Итого контрактные: 120 сек
- Осталось: 3600 - 120 = 3480 сек
- Заполнить филлерами C и D

Результат: `[A, C, B, D, C, A, D, C, B, A, ...]`

### Расчет заработка

**Базовая формула:**
```
Earnings = Duration × Base_Rate × Prime_Time_Multiplier
```

**Параметры:**
- `Duration` - длительность воспроизведения (секунды)
- `Base_Rate` - базовая ставка за секунду (100 сум)
- `Prime_Time_Multiplier` - 1.5x для праймтайма (18:00-22:00), иначе 1.0x

**Пример:**
- Видео 30 сек в обычное время: 30 × 100 = 3,000 сум
- Видео 30 сек в праймтайм: 30 × 100 × 1.5 = 4,500 сум

### Кеширование видео (Mobile)

**Стратегия:**

1. **При загрузке плейлиста:**
   - Получить список всех видео в плейлисте
   - Начать загрузку в фоне через `flutter_cache_manager`
   - Приоритет: следующие 5 видео

2. **При воспроизведении:**
   - Проверить наличие в кеше
   - Если есть - воспроизвести из файла
   - Если нет - стриминг с сервера и загрузка в кеш

3. **Управление кешем:**
   - Максимальный размер: 2 ГБ
   - Максимальный возраст: 7 дней
   - Автоматическая очистка старых файлов

## Безопасность

### Аутентификация

1. **Логин:**
   - POST /auth/login с логином и паролем
   - Получение JWT токена (срок действия: 30 дней)
   - Хранение токена в SharedPreferences

2. **Авторизация запросов:**
   - Добавление заголовка: `Authorization: Bearer <token>`
   - Автоматически через interceptor в Dio

3. **Обработка истечения токена:**
   - При получении 401: автоматический logout
   - Переход на экран авторизации

### Хранение паролей

- Bcrypt хеширование с солью
- Никогда не хранить plain-text пароли
- Минимальная длина пароля: 8 символов

## Масштабирование

### Backend

**Горизонтальное масштабирование:**
- Несколько инстансов FastAPI за load balancer
- Stateless архитектура (состояние в БД и Redis)
- Использование Redis для кеширования плейлистов

**Оптимизация БД:**
- Индексы на часто запрашиваемые поля
- Партиционирование таблицы playback_logs по дате
- Connection pooling

**Кеширование:**
- Redis для плейлистов (TTL: 1 час)
- CDN для статических видео файлов

### Mobile

**Оптимизация:**
- Ленивая загрузка видео
- Сжатие HTTP запросов (gzip)
- Batch отправка аналитики
- Offline режим с локальной очередью

## Мониторинг

### Метрики

**Backend:**
- Количество активных автомобилей
- Количество воспроизведений в час
- Среднее время сессии
- Ошибки API (4xx, 5xx)
- Время отклика API

**Mobile:**
- Crash rate
- Количество воспроизведенных видео
- Ошибки загрузки видео
- Использование памяти

### Логирование

**Backend:**
- Structured logging (JSON)
- Уровни: DEBUG, INFO, WARNING, ERROR
- Ротация логов

**Mobile:**
- Локальные логи для отладки
- Отправка критических ошибок на сервер

## Будущие улучшения

### Фаза 2: Приложение для водителей

**Функции:**
- Просмотр личной статистики
- График заработка по дням
- Детализация по видео
- Push уведомления о достижениях

### Фаза 3: Админ панель

**Функции:**
- Управление автомобилями
- Загрузка и управление видео
- Dashboard с аналитикой
- Отчеты и экспорт данных
- Управление тарифами
- Финансовые отчеты

### Фаза 4: Расширенная аналитика

**Функции:**
- Machine Learning для оптимизации плейлистов
- A/B тестирование видео
- Геолокация и анализ маршрутов
- Интеграция с рекламными платформами

### Фаза 5: Монетизация

**Функции:**
- Интеграция платежных систем
- Автоматические выплаты водителям
- Биллинг для рекламодателей
- Динамическое ценообразование
